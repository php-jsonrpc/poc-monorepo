name: Resolve packages branches
description: |
  Append `monorepo_branch`, `monorepo_maintenance_branch`, and `package_maintenance_branch` properties to provided list.
  - `monorepo_branch` (string): Current branch inside the monorepo
  - `monorepo_maintenance_branch` (string | null): Branch to update inside the monorepo (=maintenance branch). `null` if nothing to update
  - `package_maintenance_branch` (string | null): Branch to synchronize on package repository side. `null` if nothing to synchronize

inputs:
  list:
    description: JSON list of packages generated by `monorepo-builder packages:list`
    required: true

outputs:
  list:
    description: Provided list augmented with `monorepo_branch`, `monorepo_maintenance_branch` and `package_maintenance_branch` properties
    value: ${{ steps.generator.outputs.list }}

runs:
  using: composite
  steps:
    - name: Enhance list
      id: generator
      shell: bash
      run: |
        # Enhance list
        echo '${{ inputs.list }}' | \
          jq -r -M ' 
            map(
              "maintenance/\(.name)/" as $maintenancePrefix
              | .monorepo_branch="${{ github.ref_name }}"
              | (.monorepo_branch == "develop") as $isMonorepoDevelopBranch
              | ($isMonorepoDevelopBranch == false && (.monorepo_branch | startswith($maintenancePrefix))) as $isMonorepoMaintenanceBranch
              | (
                if .package_tag !== null then (.package_tag | capture("^(?<major>[0-9]+)\.(?<minor>[0-9]+)") | "\(.major).\(.minor)"
                  else null
                end
              ) as $shortRevision
              | .monorepo_maintenance_branch=(
                if $isMonorepoDevelopBranch && $shortRevision != null then "\($maintenancePrefix)\($shortRevision)"
                  else null
                end
              )
              | .package_maintenance_branch=(
                if $isMonorepoMaintenanceBranch && $shortRevision != null then $shortRevision
                  elif $isMonorepoMaintenanceBranch && $shortRevision == null then (.monorepo_branch | ltrimstr($maintenancePrefix))
                  elif $isMonorepoDevelopBranch then "develop"
                  else null
                end
              )
            )
            | tostring
          ' > list.json
        cat list.json | jq
        echo "list=$(cat list.json)" >> $GITHUB_OUTPUT
