name: Resolve packages branches
description: |
  Append `current_branch`, `target_branch` and `is_external_target_branch` property to provided list.
  `target_branch`:
    - For a push to `develop` branch, target will be packages split branches
    - Else
      - For package having a `revision` field, target will be package split branch related to the revision
      - else target will be the related packages branch on the synchronized repository
  `is_external_target_branch`: true if target is a branch on the package synchronized repository

outputs:
  list:
    description: Provided list augmented with `current_branch`, `target_branch` and `is_external_target_branch` property
    value: ${{ steps.generator.outputs.list }}
inputs:
  list:
    description: JSON list of packages generated by `monorepo-builder packages:list`
    required: true

runs:
  using: composite
  steps:
    - name: Enhance list
      id: generator
      shell: bash
      run: |
        # Enhance list
        echo '${{ inputs.list }}' | \
          jq -r -M ' 
            map( 
              "split/\(.name)/" as $prefix | 
              .current_branch="develop"  | 
              .target_branch=(
                if .current_branch == "develop" then "\($prefix)develop" 
                  elif .revision then "\($prefix)(.revision)" 
                  else .current_branch | ltrimstr($prefix) 
                end
              ) | 
              .is_external_target_branch=(.target_branch == (.current_branch | ltrimstr($prefix))) 
            ) 
            | tostring 
          ' > list.json
        cat list.json | jq
        echo "list=$(cat list.json)" >> $GITHUB_OUTPUT
