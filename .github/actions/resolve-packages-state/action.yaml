name: Resolve packages state
description: Output list of known packages
outputs:
  list:
    description: List of updated packages
    value: ${{ steps.list-generator.outputs.list }}
inputs:
  list:
    description: JSON list of packages generated by `monorepo-builder packages:list`
    required: true

runs:
  using: composite
  steps:
    - name: Generate path list
      id: path_list
      shell: bash
      # Do not run command inside a $(...) clause, else errors won't be caught !
      run: |
        # Generate path list
        echo '${{ inputs.list }}' | \
          jq -r -M 'map("            \(.name):\n              - added|modified: '"'"'\(.path)/**'"'"'") | add' | \
          tee filters.txt
        EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
        echo "filters<<$EOF" >> "$GITHUB_OUTPUT"
        cat filters.txt >> "$GITHUB_OUTPUT"
        echo "$EOF" >> "$GITHUB_OUTPUT"

    - name: Find updated packages
      uses: dorny/paths-filter@v2
      id: changes
      with:
        list-files: json
        filters: ${{ steps.path_list.outputs.filters }}

    - name: Generate extra params pattern
      id: extra-params-pattern
      shell: bash
      # Do not run command inside a $(...) clause, else errors won't be caught !
      run: |
        # Generate extra params pattern
        echo "${{ inputs.split-branch-pattern && format(', \"split_branch\": \"{0}\"', inputs.split-branch-pattern) || '' }}" > extra.txt
        cat extra.txt
        echo "extra=$(cat extra.txt)" >> $GITHUB_OUTPUT

    - name: Re-enerate packages list
      id: list-generator
      shell: bash
      # Do not run command inside a $(...) clause, else errors won't be caught !
      run: |
        # Re-enerate packages list
        echo '[${{ inputs.list }},${{ steps.changes.outputs.changes }}]' | \
          jq -r -M '.[1] as $list | .[0] | map({ "\(.name)": (. + { "state": (.name as $name | if $list | contains([$name]) then "updated" else "none" end )${{ steps.extra-params-pattern.outputs.extra }} } ) }) | add | tostring' \
          > list.json
        cat list.json | jq
        echo "list=$(cat list.json)" >> $GITHUB_OUTPUT
