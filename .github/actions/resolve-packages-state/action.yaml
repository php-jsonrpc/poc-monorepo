name: Resolve packages state
description: Append `updated` property to provided list
outputs:
  list:
    description: Provided list augmented with `updated` property
    value: ${{ steps.list-generator.outputs.list }}
inputs:
  list:
    description: JSON list of packages generated by `monorepo-builder packages:list`
    required: true

runs:
  using: composite
  steps:
    - name: Generate path list
      id: path_list
      shell: bash
      run: |
        # Generate path list
        echo '${{ inputs.list }}' | \
          jq -r -M 'map("            \(.name):\n              - added|modified: '"'"'\(.path)/**'"'"'") | add' | \
          tee filters.txt
        EOF=$(dd if=/dev/urandom bs=15 count=1 status=none | base64)
        echo "filters<<$EOF" >> "$GITHUB_OUTPUT"
        cat filters.txt >> "$GITHUB_OUTPUT"
        echo "$EOF" >> "$GITHUB_OUTPUT"

    - name: Find updated packages
      uses: dorny/paths-filter@v2
      id: changes
      with:
        list-files: json
        filters: ${{ steps.path_list.outputs.filters }}

    - name: Re-enerate packages list
      id: list-generator
      shell: bash
      run: |
        # Re-enerate packages list
        echo '[${{ inputs.list }},${{ steps.changes.outputs.changes }}]' | \
          jq -r -M '.[1] as $list | .[0] | map({ "\(.name)": (. + { "updated": (.name as $name | if $list | contains([$name]) then true else false end ) } ) }) | add | tostring' \
          > list.json
        cat list.json | jq
        echo "list=$(cat list.json)" >> $GITHUB_OUTPUT
